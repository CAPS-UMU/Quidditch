# Time Travel Branch

- We are trying to go back in time to when our sensitivity analysis results made sense.

- If we can reproduce our old sensitivity analysis results, **we can use this branch as a reference for our cleaner branch** which seems to produce incorrect timing results.

## Running a few more tiling schemes

I'm going to run a few more tiling schemes to make sure I am reproducing the old sensitivity analysis results.



## Avoiding Iree-turbine front end errors

I'm going to provide the nsnet2 MLIR instead of converting it from python with iree-turbine.

- I already had `theMLIR.mlir`, but I needed the bitcode version
- I copied the `nsnet2.mlirbc` from an old build that worked, then pasted it into the `nsnet2` and `grapeFruit` directories.
- Inside `NsNet2.py` and `Grapefruit.py`:

```
# I am using the following code to bypass the iree-turbine front end vvvvvvvvvvvvvvvvv
print("WARNING: Bypassing iree-turbine python to mlir conversion!")
byPass="/home/emily/Quidditch/runtime/samples/nsnet2/bypass-iree-turbine.sh"
bc = "/home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc"
import subprocess
subprocess.call(['sh', byPass, bc, args.output]) 
# I am using the above code to bypass the iree-turbine front end ^^^^^^^^^^^^^^^^^^^^^
```

- Inside `Quidditch/runtime/samples/nsnet2/bypass-iree-turbine.sh`:

```
#echo "arguments are $0 $1 $2" # debugging
cp $1 $2 # copy source to destination
```

## Comparing old NsNet2 MLIR with the new MLIR generated by hacky python "fix"

- from hacky venv: `/home/emily/Downloads/theMLIRHere.mlir`

- from working venv way back: `/home/emily/Quidditch/runtime/samples/grapeFruit/theMLIR.mlir`

`diff /home/emily/Quidditch/runtime/samples/grapeFruit/theMLIR.mlir /home/emily/Downloads/theMLIRHere.mlir`

Apparently, no difference.

what about the bitcode?

- from hacky venv: `/home/emily/Downloads/grapeFruit.mlirbc`
- frmo working venv long back: `/home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc`

`diff /home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc /home/emily/Downloads/grapeFruit.mlirbc`

Apparently they differ:

```
emily@ProfessorPlum:~/Quidditch/build$ diff /home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc /home/emily/Downloads/grapeFruit.mlirbc
Binary files /home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc and /home/emily/Downloads/grapeFruit.mlirbc differ
```

Let's investigate a bit more:

```
sudo apt install vbindiff
```

```
vbindiff /home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc /home/emily/Downloads/grapeFruit.mlirbc
```

```
cmp /home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc /home/emily/Downloads/grapeFruit.mlirbc
```

```
cmp /home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc /home/emily/Downloads/grapeFruit.mlirbc
/home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc /home/emily/Downloads/grapeFruit.mlirbc differ: byte 21511378, line 66585
```

```
emily@ProfessorPlum:~/Quidditch/build$ ll /home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc /home/emily/Downloads/grapeFruit.mlirbc
-rw-rw-r-- 1 emily emily 21513101 Jul 25 22:49 /home/emily/Downloads/grapeFruit.mlirbc
-rw-rw-r-- 1 emily emily 21513091 Jul  9 15:04 /home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc
```

**What if I gave my grapefruit this other bitcode? would it give the same output?**

Change to `grapeFruit.py`:

```
# I am using the following code to bypass the iree-turbine front end vvvvvvvvvvvvvvvvv
print("WARNING: Bypassing iree-turbine python to mlir conversion!")
byPass="/home/emily/Quidditch/runtime/samples/nsnet2/bypass-iree-turbine.sh"
bc = "/home/emily/Quidditch/runtime/samples/grapeFruit/grapeFruit.mlirbc"
import subprocess
subprocess.call(['sh', byPass, bc, args.output]) 
# I am using the above code to bypass the iree-turbine front end ^^^^^^^^^^^^^^^^^^^^^
```

GrapeFruit and NsNet2 run normally with the other bitcode. Their output is correct, and there timing looks normal.

Bitcode from hacky fix on lab computer: `/home/emily/Quidditch/runtime/samples/grapeFruit/grapefruit-output-grapefruit-mlirbc.txt`

Bitcode from before my laptop venv has sharkturbine errors: `/home/emily/Quidditch/runtime/samples/nsnet2/nsnet2.mlirbc`

## Building + Running

```
cd build
```

Configure:

```
cmake .. -GNinja \
  -DCMAKE_C_COMPILER=clang \
  -DCMAKE_CXX_COMPILER=clang++ \
  -DCMAKE_C_COMPILER_LAUNCHER=ccache \
  -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
  -DQUIDDITCH_TOOLCHAIN_FILE=../toolchain/ToolchainFile.cmake
```

Build:

```
ninja -j 20
```

Run:

```
../toolchain/bin/snitch_cluster.vlt /home/emily/Quidditch/build/runtime/samples/grapeFruit/GrapeFruit
```

```
../toolchain/bin/snitch_cluster.vlt /home/emily/Quidditch/build/runtime/samples/nsnet2/NsNet2
```

## BigMatVec Segfault while building

Every once in a while, I get a segfault while building bigmatvec. Why? Is it something *I* did, or is it like this on the main Quidditch repo as well?

```
[122/163] Generating big_matvec/big_matvec_module.h, big_matvec/big_matvec.o, big_matvec/big_matvec.h, big_matvec/big_matvec_llvm.h
FAILED: samples/big_matvec/big_matvec/big_matvec_module.h samples/big_matvec/big_matvec/big_matvec.o samples/big_matvec/big_matvec/big_matvec.h samples/big_matvec/big_matvec/big_matvec_llvm.h /home/emily/Quidditch/build/runtime/samples/big_matvec/big_matvec/big_matvec_module.h /home/emily/Quidditch/build/runtime/samples/big_matvec/big_matvec/big_matvec.o /home/emily/Quidditch/build/runtime/samples/big_matvec/big_matvec/big_matvec.h /home/emily/Quidditch/build/runtime/samples/big_matvec/big_matvec/big_matvec_llvm.h 
cd /home/emily/Quidditch/build/runtime/samples/big_matvec && /home/emily/Quidditch/build/codegen/iree-configuration/iree/tools/iree-compile --iree-vm-bytecode-module-strip-source-map=true --iree-vm-emit-polyglot-zip=false --iree-input-type=auto --iree-input-demote-f64-to-f32=0 --iree-hal-target-backends=quidditch --iree-quidditch-static-library-output-path=/home/emily/Quidditch/build/runtime/samples/big_matvec/big_matvec/big_matvec.o --iree-quidditch-xdsl-opt-path=/home/emily/Quidditch/venv/bin/xdsl-opt --iree-quidditch-toolchain-root=/home/emily/Quidditch/toolchain --iree-quidditch-assert-compiled=true --output-format=vm-c --iree-vm-target-index-bits=32 /home/emily/Quidditch/runtime/samples/big_matvec/big_matvec.mlir -o /home/emily/Quidditch/build/runtime/samples/big_matvec/big_matvec/big_matvec_module.h
malloc(): unaligned tcache chunk detected
Please report issues to https://github.com/iree-org/iree/issues and include the crash backtrace.
Segmentation fault (core dumped)
```

